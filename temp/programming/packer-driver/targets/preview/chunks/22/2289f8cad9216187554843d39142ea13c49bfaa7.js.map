{"version":3,"sources":["file:///D:/cocos%20creator%20project/TeamBattle/assets/resources/scripts/pop/popuplabel/label-anim-runtime-data.ts"],"names":["easing","lerp","LabelAnimData","LabelAnimState","ObjectPool","LabelAnimRuntimeInfo","register","layout","data","allocate","len","ts","progress","current","shouldRecycle","initialize","anim","font","spacingX","text","length","copy","_prepareLayoutData","release","reset","update","dt","Math","min","duration","r","ease","scale","from","to","rotate","color","g","b","a","position","x","y","LetterOffset","fontHeight","fntConfig","commonHeight","indexOffset","letterW","i","config","fontDefDictionary","charCodeAt","xAdvance","rect","width","height","yOffset"],"mappings":"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","sourcesContent":["import { BitmapFont, Rect, easing, lerp } from \"cc\";\nimport { LabelAnimData } from \"./label-anim-data\";\nimport { LabelAnimState } from \"./label-anim-state\";\nimport { ObjectPool, PoolItem } from \"./object-pool\";\n\n@ObjectPool.register()\nexport class LabelAnimRuntimeInfo implements PoolItem {\n    initialize(anim: LabelAnimData, font: BitmapFont, spacingX: number) {\n        this.progress = 0;\n        this.ts = 0;\n        this.shouldRecycle = false;\n        this.len = anim.text.length;\n        this.data.copy(anim);\n        this._prepareLayoutData(font, spacingX);\n    }\n\n    release() {\n        this.current.reset();\n        this.layout.length = 0;\n    }\n\n    update(dt: number) {\n        this.ts += dt;\n        this.progress = Math.min(1, this.ts / this.data.duration);\n        const r = easing[this.data.ease](this.progress);\n        this.current.scale = lerp(this.data.from.scale, this.data.to.scale, r);\n        this.current.rotate = lerp(this.data.from.rotate, this.data.to.rotate, r);\n        this.current.color.r = lerp(this.data.from.color.r, this.data.to.color.r, r);\n        this.current.color.g = lerp(this.data.from.color.g, this.data.to.color.g, r);\n        this.current.color.b = lerp(this.data.from.color.b, this.data.to.color.b, r);\n        this.current.color.a = lerp(this.data.from.color.a, this.data.to.color.a, r);\n        this.current.position.x = lerp(this.data.from.position.x, this.data.to.position.x, r);\n        this.current.position.y = lerp(this.data.from.position.y, this.data.to.position.y, r);\n        if (this.progress >= 1) {\n            this.shouldRecycle = true;\n        }\n    }\n\n    private _prepareLayoutData(font: BitmapFont, spacingX: number) {\n        this.layout.length = this.len * LabelAnimRuntimeInfo.LetterOffset;\n        const fontHeight = font.fntConfig.commonHeight as number;\n        let indexOffset = 0;\n        let letterW = 0;\n        for (let i = 0; i < this.len; i++) {\n            /**\n             * @see https://www.angelcode.com/products/bmfont/doc/file_format.html\n             */\n            const config = font.fntConfig.fontDefDictionary[this.data.text.charCodeAt(i)] as {\n                rect: Rect;\n                /** 渲染字体时x方向的调整 */\n                xOffset: number;\n                /** 渲染字体时y方向的调整 */\n                yOffset: number;\n                /** 渲染字体时字体的宽度, 渲染一个字体后, 下一个字体从x+=xadvance处开始 */\n                xAdvance: number;\n            };\n            if (letterW === 0) {\n                letterW = -config.xAdvance / 2;\n            }\n            this.layout[indexOffset++] = config.rect.x;\n            this.layout[indexOffset++] = config.rect.y;\n            this.layout[indexOffset++] = config.rect.width;\n            this.layout[indexOffset++] = config.rect.height;\n            this.layout[indexOffset++] = config.xAdvance + letterW + spacingX;\n            this.layout[indexOffset++] = -fontHeight / 2 + config.yOffset;\n            letterW += (config.xAdvance + spacingX);\n        }\n        for (let i = 0; i < this.len; i++) {\n            this.layout[i * LabelAnimRuntimeInfo.LetterOffset + 4] -= letterW / 2;\n        }\n    }\n\n    /** u v w h offsetx offsety */\n    static readonly LetterOffset = 6;\n\n    /** layout data */\n    layout: number[] = [];\n    /** 动画数据 */\n    data = ObjectPool.allocate(LabelAnimData);\n    /** 字符串长度 */\n    len: number;\n    /** 运行时间，单位ms */\n    ts: number;\n    /** 当前进度 */\n    progress: number = 0;\n    /** 当前状态 */\n    current = new LabelAnimState();\n    /** 回收标记 */\n    shouldRecycle: boolean = false;\n}"]}